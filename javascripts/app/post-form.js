(function(){var t,e;window.currentUserTimezone="Australia/Sydney",moment.tz.setDefault(currentUserTimezone),window.PostForm=function(){function i(t){this.modal=t,this._init(),this._addEventListeners()}return i.prototype.ERROR_CLASS="error",i.prototype.VISIBILITY_CLASS="visible",i.prototype.HIDDEN_CLASS="hidden",i.prototype.MINUTES_INTERVAL=30,i.prototype._init=function(){return this._initUI(),this._initData(),this._initComponents()},i.prototype._initUI=function(){return this.ui={},this.ui.$form=$("#new-post"),this.ui.$postBtn=$(".new-post-modal__btn.submit"),this.ui.$contentBlock=$(".accordion__item--content"),this.ui.$scheduleBlock=$(".accordion__item--schedule"),this.ui.$contentTextarea=$("#new-post-modal__content"),this.ui.$contentCounter=$("#new-post-modal__counter"),this.ui.$accountCheckboxes=this.ui.$form.find(".new-post-modal__account-checkbox"),this.ui.$dateInput=$("#new-post-modal__date"),this.ui.$timeInput=$("#new-post-modal__time"),this.ui.$times_list="",this.ui.$timeColumn=$(".new-post-modal__schedule-column--time"),this.ui.$validationBlock=$(".new-post-modal__validation-status"),this.ui.$uploadBtn=$(".new-post-modal__upload-btn"),this.ui.$bannerBtn=$(".new-post-modal__banner-btn"),this.ui.$fileUploader=$("#fileupload"),this.ui.$postImg=$(".new-post-modal__img"),this.ui.$removeImgBtn=$(".destroy-image"),this.ui.$editBannerBtn=$(".edit-banner"),this.ui.$gallery=$(".gallery-wrapper"),this.ui.$imageIds=$(".img-ids"),this.ui.$maxFileSize=$(".max-size"),this.ui.twitterIcon=".new-post-modal__social-icon--twitter",this.ui.linkWrapper="#link-wrapper",this.ui.linkTitle="#link-wrapper .post-content__title",this.ui.linkDescription="#link-wrapper .post-content p:last",this.ui.linkDelete="#link-wrapper #delete-link",this.ui.linkSpinner="#link-spinner",this.ui.scheduleWrapper="#schedule",this.ui.datePicker="#datepicker",this.ui.datePickerWidget=".bootstrap-datetimepicker-widget",this.ui.datePickerArea="#datepicker, #new-post-modal__date",this.ui.modal=this.modal.selector,this.ui.validationMessages={$all:$(".new-post-modal__validation-msg"),$content:$(".new-post-modal__validation-msg--type-message"),$date:$(".new-post-modal__validation-msg--choose-date"),$account:$(".new-post-modal__validation-msg--choose-account"),$image:$(".new-post-modal__validation-msg--image-error")}},i.prototype._initData=function(){return this.data={},this.data.isFormSubmitted=!1},i.prototype._initComponents=function(){return this._initDatepicker(),this._generateDays(),this._generateTime(),this._filterTimeOptions(),this._onDateUpdate(),this.highlightTextarea=new e(this),this.crawlLink=new t(this)},i.prototype._initDatepicker=function(){return $(this.ui.scheduleWrapper).one("shown.bs.collapse",function(t){return function(){return $(t.ui.datePicker).datetimepicker({format:"DD/MM/YYYY",minDate:moment.tz(currentUserTimezone).startOf("day")}),$(t.ui.datePicker).on("dp.change",function(e){return t._onDatePickerUpdate(e),t._onDateUpdate()}),$(t.ui.datePicker).on("dp.hide",function(){var e,i;if("Other date..."===$(t.ui.$dateInput).find("option:selected").text())return e=t._datepicker().date(),i=e.format("DD/MM/YYYY"),$(t.ui.$dateInput).val(i)}),$(t.ui.modal).on("click",function(e){var i,n,o;if(n=$(t.ui.datePickerWidget).length>0,o=0===$(e.target).closest(t.ui.datePickerArea).length,n&&o)return i=t._datepicker().date().format("DD/MM/YYYY"),t.ui.$dateInput.val(i),t._hideDatepicker()})}}(this))},i.prototype._onDatePickerUpdate=function(t){var e,i,n,o;return i=t.date.format("DD/MM/YYYY"),o=this.ui.$dateInput.data("selected")===i,n=$(this.ui.$dateInput).find("option[value='"+i+"']").length>0,e=$('<option value="'+i+'" selected>'+i+"</option>"),e.prop("selected",o),n||this.ui.$dateInput.append(e),this._sortDates(),this.ui.$dateInput.val(i)},i.prototype._sortDates=function(){var t,e,i,n;i=this.ui.$dateInput.find("option:selected").val(),e=this.ui.$dateInput.find("option:gt(1)"),t=e.map(function(t,e){return{t:$(e).text(),v:moment.tz(e.value,"DD/MM/YYYY",currentUserTimezone)}}).get(),t.sort(function(t,e){return t.v.diff(e.v)});for(n in t)"Other date..."===t[n].t&&t.push(t.splice(n,1)[0]);return e.each(function(e,i){return i.value=t[e].v.format("DD/MM/YYYY"),$(i).text(t[e].t)}),this.ui.$dateInput.val(i)},i.prototype._showDatepicker=function(){return this._datepicker().show()},i.prototype._datepicker=function(){return $(this.ui.datePicker).data("DateTimePicker")},i.prototype._hideDatepicker=function(){return this._datepicker().hide()},i.prototype._onCustomDateUpdate=function(){var t,e;return"Other date..."===$(this.ui.$dateInput).find("option:selected").text()?this._showDatepicker():this._datepicker()?(t=$(this.ui.$dateInput).find("option:selected").val(),e=moment.tz(t,"DD/MM/YYYY",currentUserTimezone),this._datepicker().date(e)):void 0},i.prototype._addEventListeners=function(){return this.ui.$postBtn.on("click",function(t){return function(e){return e.preventDefault(),t._submitForm()}}(this)),this.ui.$contentTextarea.on("input",function(t){return function(){if(t.data.isFormSubmitted)return t._toggleContentValidation(),t._toggleValidationErrors()}}(this)),this.ui.$accountCheckboxes.on("change",function(t){return function(){if(t.data.isFormSubmitted)return t._toggleAccountValidation(),t._toggleValidationErrors()}}(this)),this.ui.$dateInput.on("change",function(t){return function(){if(t._onCustomDateUpdate(),t._onDateUpdate(),t.data.isFormSubmitted)return t._toggleValidationErrors()}}(this)),this.ui.$uploadBtn.on("click",function(t){return function(e){return e.preventDefault(),t.ui.$fileUploader.trigger("click"),t._showRemoveImgBtn()}}(this)),this.ui.$bannerBtn.on("click",function(t){return function(e){return e.preventDefault(),t._openBannerBuilder(),t._showRemoveImgBtn()}}(this)),this.ui.$editBannerBtn.on("click",function(t){return function(e){return e.preventDefault(),t._openBannerBuilder()}}(this)),this.ui.$removeImgBtn.on("click",function(t){return function(){return t.removeImage()}}(this))},i.prototype._isContentValid=function(){return!this.ui.$contentTextarea.hasClass("required")||this.ui.$contentTextarea.val().trim().length>0},i.prototype._isSocialAccountSelected=function(){return this.ui.$accountCheckboxes.filter(":checked").length>0},i.prototype._isFormValid=function(){return this._isContentValid()&&this._isSocialAccountSelected()},i.prototype._toggleAccountValidation=function(){return this.ui.validationMessages.$account.toggle(!this._isSocialAccountSelected()),this.ui.$contentBlock.toggleClass(this.ERROR_CLASS,!this._isSocialAccountSelected())},i.prototype._toggleContentValidation=function(){return this.ui.validationMessages.$content.toggle(!this._isContentValid()),this.ui.$contentBlock.toggleClass(this.ERROR_CLASS,!this._isContentValid())},i.prototype._toggleValidationErrors=function(){return this.toggleImageValidation(),this._isFormValid()?this._hideValidationErrors():this._showValidationErrors()},i.prototype._hideValidationErrors=function(){return this.ui.$validationBlock.removeClass(this.VISIBILITY_CLASS),this.ui.validationMessages.$all.hide()},i.prototype._showValidationErrors=function(){return this.ui.$validationBlock.addClass(this.VISIBILITY_CLASS),this._toggleAccountValidation(),this._toggleContentValidation()},i.prototype._showRemoveImgBtn=function(){return this.ui.$removeImgBtn.removeClass(this.HIDDEN_CLASS)},i.prototype.toggleImageValidation=function(t){var e;return null==t&&(t=""),e=t.length>0,this.ui.$validationBlock.toggleClass(this.VISIBILITY_CLASS,e),this.ui.validationMessages.$image.text(t).toggle(e),this.ui.$contentBlock.toggleClass(this.ERROR_CLASS,e)},i.prototype._submitForm=function(){return this.data.isFormSubmitted=!0,this._isFormValid()?(this._hideValidationErrors(),this.ui.$form.submit(),this.modal.modal("hide")):this._showValidationErrors()},i.prototype.showImage=function(){var t,e;if(t=this.ui.$fileUploader[0].files[0])return e=new FileReader,e.onload=function(t){return function(e){return t.ui.$postImg.attr("src",e.target.result),t.ui.$gallery.removeClass(t.HIDDEN_CLASS),t.ui.$editBannerBtn.addClass(t.HIDDEN_CLASS),t.toggleImageSpinner(!1)}}(this),e.readAsDataURL(t)},i.prototype.toggleImageSpinner=function(t){return this.ui.$uploadBtn.toggleClass("new-post-modal__upload-btn--loading",t)},i.prototype.removeImage=function(){return this.ui.$postImg.attr("src",""),this.ui.$gallery.addClass(this.HIDDEN_CLASS),this.ui.$editBannerBtn.removeAttr("data"),this.ui.$imageIds.val(""),this.toggleTextAreaCounter(!1)},i.prototype.setImageId=function(t){return this.ui.$form.find(".destroy-image").data("id",t),this.ui.$imageIds.val(t)},i.prototype.rebindFileUploader=function(){return this.ui.$fileUploader=$("#fileupload")},i.prototype._onDateUpdate=function(){var t;return t=this._getChosenDate(),this._isScheduledDate()?(this._showScheduleButton(),this._showTimeColumn()):(this._showPostButton(),this._hideTimeColumn()),this._isTodayDate(t)&&this._isScheduledDate()?this._filterTimeOptions():this._resetTimeOptions()},i.prototype._getChosenDate=function(){return moment.tz(this.ui.$dateInput.val(),"DD/MM/YYYY",currentUserTimezone)},i.prototype._isScheduledDate=function(){return this.ui.$dateInput.prop("selectedIndex")>0},i.prototype._isTodayDate=function(t){return t.isSame(moment.tz(currentUserTimezone),"day")},i.prototype._showScheduleButton=function(){return this.ui.$postBtn.val("Schedule Post")},i.prototype._showPostButton=function(){return this.ui.$postBtn.val("Post Now")},i.prototype._generateDays=function(){var t,e,i,n,o;for(this.ui.$dateInput.append("<option value='' selected>Now</option>"),e=[],t=moment.tz(currentUserTimezone).subtract(1,"day"),n=0;n<=6;++n)i=t.add(1,"day").format("DD/MM/YYYY"),e.push(i),this._renderDateOption(i);return this._renderCustomDateOption(),o=this.ui.$dateInput.data("selected"),null!=o&&-1===e.indexOf(o)&&this._renderDateOption(o),this._sortDates()},i.prototype._generateTime=function(){var t,e,i,n,o,r;for(r=moment.tz(this.ui.$timeInput.data("selected"),"hh:mm A",currentUserTimezone),t=moment.tz(currentUserTimezone).startOf("day"),e=1440/this.MINUTES_INTERVAL,i=1,o=e;1<=o?i<=o:i>=o;1<=o?i++:i--)this._renderTimeOption(t.format("hh:mm A")),n=moment(t).add(this.MINUTES_INTERVAL,"minutes"),r.isBetween(t,n,"minutes")&&this._renderTimeOption(r.format("hh:mm A")),t.add(this.MINUTES_INTERVAL,"minutes");return this.ui.$times_list=this.ui.$timeInput.clone()},i.prototype._filterTimeOptions=function(){var t,e;return t=moment.tz(currentUserTimezone),e=this.ui.$dateInput.val(),this.ui.$timeInput.find("option").filter(function(){var i;return i=moment.tz(e+" "+$(this).val(),"DD/MM/YYYY hh:mm A",currentUserTimezone),i.isBefore(t)}).remove(),this.ui.$timeInput.val(""),this._selectDefaultTime()},i.prototype._resetTimeOptions=function(){return this.ui.$timeInput.html(this.ui.$times_list.html()),this._selectDefaultTime()},i.prototype._selectDefaultTime=function(){var t;return t=this.ui.$timeInput.data("selected"),t?this.ui.$timeInput.find("option[value='"+t+"']").prop("selected",!0):this.ui.$timeInput.prop("selectedIndex")<0?this.ui.$timeInput.find("option:not(.hidden)").first().prop("selected",!0):void 0},i.prototype._renderTimeOption=function(t){return this.ui.$timeInput.append("<option value='"+t+"'>"+t+"</option>")},i.prototype._renderDateOption=function(t){var e,i,n,o;return i=this.ui.$dateInput.data("selected")===t,o=moment.tz(currentUserTimezone).format("DD/MM/YYYY"),n=o===t?"Today":t,e=$('<option value="'+t+'">'+n+"</option>"),e.prop("selected",i),this.ui.$dateInput.append(e)},i.prototype._renderCustomDateOption=function(){var t;return t=$('<option value="">Other date...</option>'),this.ui.$dateInput.append(t)},i.prototype._showTimeColumn=function(){return this.ui.$timeColumn.show(),this.ui.$timeInput.prop("disabled",!1)},i.prototype._hideTimeColumn=function(){return this.ui.$timeColumn.hide(),this.ui.$timeInput.prop("disabled",!0)},i.prototype._openBannerBuilder=function(){return this._fillBannerModal()},i.prototype._fillBannerModal=function(){return $.ajax({url:"/user/banner_builder"}).done(function(){return function(t){return $(".banner-modal__body").html(t)}}())},i.prototype.displayBanner=function(t,e){return this.ui.$postImg.attr("src",t),this.ui.$gallery.removeClass(this.HIDDEN_CLASS),this.ui.$editBannerBtn.removeClass(this.HIDDEN_CLASS),this.ui.$editBannerBtn.attr("data",e),this.rebindFileUploader(),this.toggleTextAreaCounter(!0)},i.prototype.hasTwitterPages=function(){var t,e;return t="."+$(this.ui.$accountCheckboxes).attr("class"),e="#"+$(this.ui.$form).attr("id"),$(e+" "+this.ui.twitterIcon+" ~ label "+t+":checked").length>0},i.prototype.toggleTextAreaCounter=function(t){return t?($(this.ui.$contentCounter).addClass("top"),this.ui.$contentCounter.insertBefore(this.ui.$gallery)):($(this.ui.$contentCounter).removeClass("top"),this.ui.$contentCounter.insertAfter(this.ui.$bannerBtn))},i.prototype._linkExists=function(){return!$(this.ui.linkWrapper).hasClass("hidden")},i}(),e=function(){function t(t){this.form=t,this.$textarea=this.form.ui.$contentTextarea,this.$counter=this.form.ui.$contentCounter,this.length=this.$counter.data("length"),this.minLength=this.$counter.data("min-length"),this.$checkbox=this.form.ui.$accountCheckboxes,this._init()}return t.prototype._init=function(){if(this._onPageChange(),this.form.hasTwitterPages())return this.$checkbox.trigger("change")},t.prototype._onPageChange=function(){return this.$checkbox.on("change",function(t){return function(){return t.form.hasTwitterPages()?t._initAll():t._hide()}}(this))},t.prototype._hide=function(){var t;return t=this.$textarea.data("hwt"),t&&t.destroy(),this.$counter.addClass("hidden")},t.prototype._initAll=function(){return this._hightlight(),this._showCounter(),this.$counter.removeClass("hidden"),this._highlightText(this.$textarea.val())},t.prototype._hightlight=function(){return $(".modal textarea").highlightWithinTextarea(function(t){return function(e){return e.length>=t.length?[[t.length,null]]:[]}}(this))},t.prototype._autoHeight=function(){var t,e;return e=this.$textarea[0],t=function(){return e.style.cssText="height:auto; padding:0",e.style.cssText="height:"+e.scrollHeight+"px"},setTimeout(function(){return t()},300),this.$textarea.on("input",function(){return t()})},t.prototype._showCounter=function(){return this.$textarea.on("input",function(t){return function(e){return t._highlightText($(e.currentTarget).val())}}(this))},t.prototype._highlightText=function(t){var e,i,n;return i=t.length,e=this.length-i,this.$counter.text(e),n=e<=this.minLength,this._highlightCounter(n)},t.prototype._highlightCounter=function(t){return this.$counter.toggleClass("red",t)},t}(),t=function(){function t(t){this.form=t,this.textarea=this.form.ui.$contentTextarea,this.linkWrapper=this.form.ui.linkWrapper,this.title=this.form.ui.linkTitle,this.description=this.form.ui.linkDescription,this.deleteLink=this.form.ui.linkDelete,this.spinner=this.form.ui.linkSpinner,this.form_ui=this.form.ui.$form,this._init()}return t.prototype._init=function(){var t;if(this._isNewPost())return t=$(this.textarea).val(),this._urlIsValid(t)&&this._crawlUrl(this.textarea),$(this.textarea).on("input",function(t){return function(e){return null!=window.fieldTimeout&&clearTimeout(window.fieldTimeout),window.fieldTimeout=setTimeout(function(){return t._crawlUrl($(e.currentTarget))},1e3)}}(this)),this._onDelete()},t.prototype._isNewPost=function(){return $(this.form_ui).hasClass("post-form")},t.prototype._onDelete=function(){return $(this.deleteLink).click(function(t){return function(){return t._clear()}}(this))},t.prototype._crawlUrl=function(t){var e,i,n;if(n=$(t).val(),n||$(this.linkWrapper).hasClass("hidden")||this._clear(),this._urlIsValid(n)){if(i=this._urlFor(n),$(this.textarea).data("url")===i)return;return this._clear(),this._toggleSpinner(!1),e={url:i},$.get("/user/articles/fetch",e).done(function(t){return function(e){return t._fillData(e,i)}}(this)).always(function(t){return function(){return $(t.textarea).data("url",i),t._toggleSpinner(!0)}}(this))}},t.prototype._toggleSpinner=function(t){return $(this.spinner).toggleClass("hidden",t)},t.prototype._urlIsValid=function(t){return!!t&&t.match(this._urlRegexp())},t.prototype._urlFor=function(t){return t.match(this._urlRegexp()).pop()},t.prototype._urlRegexp=function(){return/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi},t.prototype._clear=function(){return this._toggle(!0),this.form.ui.$gallery.addClass(this.form.HIDDEN_CLASS),$(this.title).text(),$(this.description).text(),$(this.textarea).data("url",null),this.form.ui.$postImg.attr("src",null),this.form.toggleTextAreaCounter(!1),this.form.rebindFileUploader()},t.prototype._fillData=function(t){return $(this.title).text(t.title),$(this.description).text(t.description),this._displayImage(t),this._toggle(!1)},t.prototype._displayImage=function(t){return this.form.ui.$removeImgBtn.addClass(this.form.HIDDEN_CLASS),this.form.ui.$postImg.attr("src",t.image.url),this.form.ui.$gallery.removeClass(this.form.HIDDEN_CLASS),this.form.ui.$editBannerBtn.addClass(this.form.HIDDEN_CLASS),this.form.ui.$editBannerBtn.attr("data",null),this.form.rebindFileUploader(),this.form.toggleTextAreaCounter(!0)},t.prototype._toggle=function(t){return $(this.linkWrapper).toggleClass("hidden",t)},t}()}).call(this);